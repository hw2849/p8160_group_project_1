---
title: "Group Project1_Monte Carlo Simulation Design."
author: "hw2849"
date: "P8160 Advanced Statistical Computing "
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

require(survival)
require(quantreg)
require(glmnet)
require(MASS)
require(pROC)

library(survival)
library(coxed)
library(nph)
library(tidyverse)

set.seed(8160)
```


\begin{description}

\item[Project 2] Design a simulation study to assess the three hypothesis testings]

\end{description}


## Project 2: Design a simulation study to assess the three hypothsis testings 

Design a set of distributions/models under both proportional-hazard and non-proportional-hazard assumptions, and carry out a simulation study to compare performance of those hypothesis tests in those models. Based on your numerical investigations, write a practical recommendation for general users to choose a suitable testing tool.  


### Non-proportional

Under non-proportional test assumption, we generate data set of a sample size n = 1000, from two different distributions, exponential distribution (p = 500) and Weibull distribution (p = 500). We have a time variable, treatment and control group, and an event variable indicating censoring. 

```{r, non-proportional data simulation}
# sampling survival times from exponential distribution & Weibull distribution
set.seed(8160)
p = 500
treatment = rep(1, 500)
control = rep(0, 500)

test_data = data.frame(
  time = c(rexp(p), rweibull(p, 0.3, 0.1)), 
  group = c(treatment, control)
) %>% 
  mutate(
    event = case_when(time >= 4 ~ 0, 
                      time < 4 ~ 1)
  )

plot(survfit(Surv(time, event) ~ group, data = test_data), 
     xlab = "Time", 
     ylab = "Overall survival probability")

# Exponential
model_exp = survreg(Surv(time, event) ~ group, test_data, dist = "exponential")
summary(model_exp)


## Weibull
model_weibull = survreg(Surv(time, event) ~ group, test_data, dist = "weibull", scale = 1)
summary(model_weibull)

```


#### Non-proportional: log-rank and weighted log-rank tests 
```{r, non-proportional, log-rank test}
## log-rank test
logrank.test(test_data$time, test_data$event, test_data$group, rho = 0, gamma = 0)

## weighted log-rank test for an early effect 
logrank.test(test_data$time, test_data$event, test_data$group, rho = 1, gamma = 0)

## weighted log-rank test for a late effect 
logrank.test(test_data$time, test_data$event, test_data$group, rho = 0, gamma = 1)


# take maximum over the previous three log-rank with multiple comparison control
logrank.maxtest(test_data$time, test_data$event, test_data$group)
```

**Decisions**

*Log-rank test:* The Chi-Squared test statistic is 115 with 1 degree of freedom and the corresponding p-value is 0. Since this p-value is less than .05, we reject the null hypothesis.

*Weighted log-rank test for an early effect:*
The Chi-Squared test statistic is 305 with 1 degree of freedom and the corresponding p-value is 0. Since this p-value is less than 0.05, we reject the null hypothesis.

*Weighted log-rank test for a late effect:*
The Chi-Squared test statistic is 0.2 with 1 degree of freedom and the corresponding p-value is 0.7. Since this p-value is greater than 0.05, we fail to reject the null hypothesis.

### Proportional

Under proportional assumption, we generate survival data with `sim.survdata` with variables `group`, `time`, and `fail`. 

* group: 1 = treatment, 0 = control

```{r, proportional simulation}
set.seed(8160)

## simulating data
sim_data = sim.survdata(N = 500, T = 100, xvars = 1, censor = .4, num.data.frames = 2) 

## data frame
test_df = data.frame( #trt = 1, ctl = 0
  time_1 = sim_data[[1]]$data$y,
  time_0 = sim_data[[2]]$data$y,
  fail_1 = sim_data[[1]]$data$failed,
  fail_0 = sim_data[[2]]$data$failed
) %>% 
  pivot_longer( # make df readable
    time_1:fail_0,
    names_to = c(".value", "group"),
    names_sep = "_"
  ) %>% 
  mutate(group = as.numeric(group))

## plot survival curves for each group
plot(survfit(Surv(time, fail) ~ group, data = test_df), 
     xlab = "Time", 
     ylab = "Overall survival probability")
```

#### Proportional: log-rank tests
```{r, proportional}
## log-rank test
logrank.test(test_df$time, test_df$fail, test_df$group, rho = 0, gamma = 0)

## weighted log-rank test for an early effect 
logrank.test(test_df$time, test_df$fail, test_df$group, rho = 1, gamma = 0)

## weighted log-rank test for a late effect 
logrank.test(test_df$time, test_df$fail, test_df$group, rho = 0, gamma = 1)

# take maximum over the previous three log-rank with multiple comparison control
logrank.maxtest(test_df$time, test_df$fail, test_df$group)
```

**Decisions** 

*Log-rank test:* The Chi-Squared test statistic is 61.7 with 1 degree of freedom and the corresponding p-value is 0. Since this p-value is less than .05, we reject the null hypothesis.

*Weighted log-rank test for an early effect:*
The Chi-Squared test statistic is 62.1 with 1 degree of freedom and the corresponding p-value is 0. Since this p-value is less than 0.05, we reject the null hypothesis.

*Weighted log-rank test for a late effect:*
The Chi-Squared test statistic is 28.8 with 1 degree of freedom and the corresponding p-value is 0. Since this p-value is greater than 0.05, we reject the null hypothesis.


type I: false positive 
type II: false negative*

repeat tests under the same setting 


